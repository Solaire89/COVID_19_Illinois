--Looking at the data in the tables
SELECT *
FROM dbo.IL_COVID_ZIP_Code_V1

SELECT *
FROM dbo.COVID_19_Daily_Vaccinations

--Making sure there's no duplicates in Row_ID
SELECT COUNT(DISTINCT Row_ID)
FROM dbo.IL_COVID_ZIP_Code_V1

--Analyze the weekly progression of 'Cases_Weekly' and 'Deaths_Weekly' over a specific period.
--Building off this basic query
SELECT
	ZIP_Code,
	Week_Number,
	Week_Start,
	Cases_Weekly,
	Deaths_Weekly
FROM dbo.IL_COVID_ZIP_Code_V1
WHERE Cases_Weekly > 0
ORDER BY Week_Start, WEEK_Number, ZIP_Code

--Calculating highest percentage of deaths per zip code
SELECT
    ZIP_Code,
    Week_Number,
    Week_Start,
	Cases_Weekly,
	Deaths_Weekly,
    MAX(Cases_Weekly) AS Max_Cases_Weekly,
	MAX(Deaths_Weekly) AS Max_Deaths_Weekly,
    LEAST(MAX(Deaths_Weekly) * 100.0 / NULLIF(MAX(Cases_Weekly), 0), 100) AS Percent_Positive_Deaths,
	Population
FROM dbo.IL_COVID_ZIP_Code_V1
WHERE Cases_Weekly > 0 AND Deaths_Weekly > 0
GROUP BY ZIP_Code, Week_Number, Week_Start, Cases_Weekly, Deaths_Weekly, Population
ORDER BY Percent_Positive_Deaths DESC;


--Calculating lowest percentage of deaths per zip code
SELECT
    ZIP_Code,
    Week_Number,
    Week_Start,
	Cases_Weekly,
	Deaths_Weekly,
    MIN(Cases_Weekly) AS Min_Cases_Weekly,
	MIN(Deaths_Weekly) AS Min_Deaths_Weekly,
    LEAST(MIN(Deaths_Weekly) * 100.0 / NULLIF(MIN(Cases_Weekly), 0), 100) AS Percent_Positive_Deaths,
	Population
FROM dbo.IL_COVID_ZIP_Code_V1
WHERE Cases_Weekly > 0 AND Deaths_Weekly > 0 AND Population <> 0
GROUP BY ZIP_Code, Week_Number, Week_Start, Cases_Weekly, Deaths_Weekly, Population
ORDER BY Percent_Positive_Deaths DESC;


--Figuring out the highest and lowest cumulative death percentage per zip code
WITH RankedData AS (
    SELECT
        ZIP_Code,
        Week_Number,
        Week_Start,
        Cases_Cumulative,
        Deaths_Cumulative,
        ROW_NUMBER() OVER (PARTITION BY ZIP_Code ORDER BY Deaths_Cumulative * 100.0 / NULLIF(Cases_Cumulative, 0) DESC) AS Rank_Highest,
        ROW_NUMBER() OVER (PARTITION BY ZIP_Code ORDER BY Deaths_Cumulative * 100.0 / NULLIF(Cases_Cumulative, 0) ASC) AS Rank_Lowest,
        Population
    FROM dbo.IL_COVID_ZIP_Code_V1
    WHERE Cases_Weekly > 0 AND Deaths_Weekly > 0 AND Population <> 0
)
SELECT
    ZIP_Code,
    Week_Number,
    Week_Start,
    Cases_Cumulative,
    Deaths_Cumulative,
    LEAST(Deaths_Cumulative * 100.0 / NULLIF(Cases_Cumulative, 0), 100) AS Percent_Positive_Deaths,
    Population
FROM RankedData
WHERE Rank_Highest = 1 OR Rank_Lowest = 1
ORDER BY ZIP_Code, Rank_Highest, Rank_Lowest;

--Exporting the data from the CTE to a csv file for visualization
WITH RankedData AS (
    SELECT
        ZIP_Code,
        Week_Number,
        Week_Start,
        Cases_Cumulative,
        Deaths_Cumulative,
        ROW_NUMBER() OVER (PARTITION BY ZIP_Code ORDER BY Deaths_Cumulative * 100.0 / NULLIF(Cases_Cumulative, 0) DESC) AS Rank_Highest,
        ROW_NUMBER() OVER (PARTITION BY ZIP_Code ORDER BY Deaths_Cumulative * 100.0 / NULLIF(Cases_Cumulative, 0) ASC) AS Rank_Lowest,
        Population
    FROM dbo.IL_COVID_ZIP_Code_V1
    WHERE Cases_Weekly > 0 AND Deaths_Weekly > 0 AND Population <> 0
)


-- Create a new table based on the CTE results
SELECT *
INTO RankedData
FROM RankedData;

--Joining the vaccination and infection rate tables
SELECT *
FROM dbo.IL_COVID_ZIP_Code_V1 AS Infection
LEFT JOIN dbo.COVID_19_Daily_Vaccinations AS Vaccination
	ON Infection.Week_End = Vaccination.Date
